# 🌍 地质数据RAG系统使用指南

## 🚀 功能特点

- **模块化设计**：数据库创建、嵌入生成、查询功能完全分离
- **手动控制**：你可以完全控制是否重新生成数据库
- **命令行参数**：灵活的运行模式和配置选项
- **文件变化检测**：当文件变化时，可以手动选择重新生成

## 📋 运行模式

### 1. 强制重新创建模式 (`--mode create`)
```bash
# 删除现有数据库，重新生成所有嵌入向量
python rag/simple_test.py --mode create
```
**适用场景**：
- 文件夹中的文件发生了变化
- 想要使用不同的嵌入模型
- 数据库出现问题需要重建

### 2. 只加载现有数据库模式 (`--mode load`)
```bash
# 只加载现有数据库，不生成新的嵌入
python rag/simple_test.py --mode load
```
**适用场景**：
- 确定文件没有变化
- 只想快速查询现有数据
- 测试查询功能

### 3. 自动模式 (`--mode auto`) - 默认
```bash
# 自动判断：有数据库就加载，没有就创建
python rag/simple_test.py --mode auto
# 或直接运行
python rag/simple_test.py
```
**适用场景**：
- 不确定数据库状态
- 首次运行
- 一般使用

## 🛠️ 命令行参数

```bash
python rag/simple_test.py \
  --mode create \
  --data-path "/path/to/your/documents" \
  --db-path "./my_database" \
  --llm-model "qwen2.5:7b" \
  --embed-model "nomic-embed-text"
```

### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--mode` | `auto` | 运行模式: `create`/`load`/`auto` |
| `--data-path` | `cr088747-2014` | 文档数据路径 |
| `--db-path` | `./simple_geological_db` | 数据库保存路径 |
| `--llm-model` | `qwen2.5:7b` | 用于回答问题的LLM模型 |
| `--embed-model` | `nomic-embed-text` | 用于生成嵌入的模型 |

## 🔄 典型使用流程

### 初次使用
```bash
# 1. 创建数据库和嵌入
python rag/simple_test.py --mode create
```

### 日常查询
```bash
# 2. 快速加载现有数据库
python rag/simple_test.py --mode load
```

### 文件变化后
```bash
# 3. 重新生成数据库
python rag/simple_test.py --mode create
```

## 📊 性能对比

| 模式 | 首次运行 | 后续运行 | 适用场景 |
|------|----------|----------|----------|
| `create` | 3-5分钟 | 3-5分钟 | 文件变化时 |
| `load` | 30-60秒 | 30-60秒 | 文件无变化时 |
| `auto` | 3-5分钟 | 30-60秒 | 一般使用 |

## 🧩 核心函数说明

### `setup_models()`
- 设置LLM和嵌入模型
- 配置文档分块参数

### `load_documents()`
- 从指定路径加载文档
- 支持PDF、DOCX、TXT、JSON格式

### `create_database_and_embeddings()`
- 创建新的ChromaDB数据库
- 生成文档的嵌入向量
- 支持强制重建选项

### `load_existing_database()`
- 加载现有的ChromaDB数据库
- 验证数据库完整性

### `test_queries()`
- 执行测试查询
- 可自定义查询内容

## 🎯 使用建议

### 何时使用 `--mode create`
- ✅ 添加了新文件
- ✅ 删除了文件
- ✅ 修改了现有文件内容
- ✅ 更换了嵌入模型
- ✅ 数据库损坏

### 何时使用 `--mode load`
- ✅ 文件没有任何变化
- ✅ 只想快速查询
- ✅ 测试不同的查询问题
- ✅ 验证系统功能

### 何时使用 `--mode auto`
- ✅ 不确定数据库状态
- ✅ 首次运行系统
- ✅ 懒得判断的时候 😄

## 🚨 注意事项

1. **文件变化检测**：系统不会自动检测文件变化，需要手动选择重建
2. **模型一致性**：确保嵌入模型与数据库中的向量匹配
3. **磁盘空间**：数据库文件可能较大，注意磁盘空间
4. **网络连接**：首次使用时需要下载模型

## 🔧 故障排除

### 问题：每次都重新生成嵌入
**解决**：使用 `--mode load` 强制加载现有数据库

### 问题：查询结果不准确
**解决**：使用 `--mode create` 重新生成数据库

### 问题：数据库损坏
**解决**：删除数据库文件夹，使用 `--mode create` 重建

## 📈 示例输出

### 创建模式
```
🌍 地质数据RAG系统
==================================================
📋 运行模式: create
📁 数据路径: /Users/.../cr088747-2014
💾 数据库路径: ./simple_geological_db
==================================================
🚀 设置模型...
✅ 模型设置完成: LLM=qwen2.5:7b, 嵌入=nomic-embed-text
🔨 强制重新创建数据库...
💾 创建数据库和嵌入向量...
🗑️  删除现有数据库...
📁 处理目录: /Users/.../cr088747-2014
✅ 加载了 6 个文档
🧮 生成向量索引...
📊 将处理 6 个文档
⏱️  请耐心等待...
Generating embeddings: 100%|████████| 9/9 [00:01<00:00, 5.47it/s]
✅ 成功生成并保存 9 个向量到数据库
```

### 加载模式
```
🌍 地质数据RAG系统
==================================================
📋 运行模式: load
📁 数据路径: /Users/.../cr088747-2014
💾 数据库路径: ./simple_geological_db
==================================================
🚀 设置模型...
✅ 模型设置完成: LLM=qwen2.5:7b, 嵌入=nomic-embed-text
📖 只加载现有数据库...
💾 加载现有数据库...
✅ 加载现有数据库，包含 9 个向量
```

现在你有了完全的控制权！🎮
